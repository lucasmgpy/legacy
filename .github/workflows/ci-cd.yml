name: CI-CD Pipeline
on:
  push:
    branches: [ main ]
jobs:
  build-test-deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Build
        run: ./build.sh
      - name: Test
        run: ./test.sh
      - name: Install Azure CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y curl zip
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
      - name: Deploy to Azure
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          az login --service-principal --username $AZURE_CLIENT_ID --password $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
          cd MeuProjeto && dotnet publish -c Release -o publish && zip -r ../publish.zip publish
          az webapp deployment source config-zip --resource-group legacylmg-rg --name legacylmg-app --src publish.zip
